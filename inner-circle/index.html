<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>waQup - Join the Inner Circle</title>
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        /* Lightweight helpers for step transitions */
        .icf-viewport { position: relative; min-height: 300px; height: calc(100vh - 64px - 96px); margin-top: 64px; margin-bottom: 96px; display: flex; align-items: center; justify-content: center; }
        .icf-step { position: absolute; inset: 0; opacity: 0; transition: opacity .3s ease; pointer-events: none; user-select: none; z-index: 10; }
        .icf-step.active { position: relative; opacity: 1; pointer-events: auto; user-select: auto; z-index: 20; }
        .icf-card { background: linear-gradient(180deg, rgba(26,26,26,.9), rgba(26,26,26,.75)); border: 1px solid rgba(59,130,246,.22); border-radius: 1rem; padding: 1.25rem; box-shadow: 0 10px 30px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.02) inset; backdrop-filter: blur(10px); min-height: 100%; max-height: 100%; display: flex; flex-direction: column; justify-content: center; width: min(820px, 96%); margin-left: auto; margin-right: auto; overflow: hidden; }
        .icf-controls { position: fixed; bottom: 16px; left: 7vw; right: 7vw; display: flex; justify-content: space-between; gap: .9rem; align-items: center; z-index: 40; }
        .icf-controls .ghost { background: transparent; border: 1px solid rgba(59,130,246,.35); color: var(--text-primary); }
        .icf-grid { display: grid; gap: .75rem; }
        /* Shell spacing and balance */
        .inner-circle .container { padding: 0; }
        #icf { width: calc(100vw - 14vw); max-width: 920px; padding: 0 1.25rem 1.5rem; margin-left: 7vw; margin-right: 7vw; margin-top: 0; box-sizing: border-box; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .icf-top { position: fixed; top: 16px; left: 7vw; right: 7vw; z-index: 40; }
        .icf-label { margin-bottom: .4rem; justify-content: space-between; gap: .5rem; }
        @media (max-width: 768px) {
          #icf { width: calc(100vw - 12vw); max-width: 720px; padding: 0 1rem 1.25rem; margin-left: 6vw; margin-right: 6vw; margin-top: 0; min-height: 100vh; }
          .icf-viewport { height: calc(100vh - 56px - 88px); margin-top: 56px; margin-bottom: 88px; }
        }
        @media (max-width: 480px) {
          #icf { width: calc(100vw - 8vw); padding: 0 .9rem 1.1rem; margin-left: 4vw; margin-right: 4vw; margin-top: 0; min-height: 100vh; }
        }
        /* Tile grid for Step 1 */
        .icf-tiles { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 1rem; }
        @media (max-width: 960px) { .icf-tiles { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (max-width: 560px) { .icf-tiles { grid-template-columns: 1fr; } }
        .icf-tile { position: relative; display: flex; align-items: center; justify-content: center; min-height: 78px; padding: .9rem; border-radius: .9rem; border: 1px solid rgba(59,130,246,.22); background: radial-gradient(120% 120% at 0% 0%, rgba(59,130,246,.08), transparent 40%), rgba(7,7,7,.42); color: var(--text-primary); cursor: pointer; transition: transform .16s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease; }
        .icf-tile:hover { transform: translateY(-2px); border-color: rgba(59,130,246,.45); box-shadow: 0 10px 24px rgba(0,0,0,.35); }
        .icf-tile input { position: absolute; inset: 0; opacity: 0; pointer-events: none; }
        .icf-tile .label { font-weight: 560; letter-spacing: .2px; }
        .icf-tile.selected { border-color: rgba(59,130,246,.7); box-shadow: 0 0 0 2px rgba(59,130,246,.2), 0 12px 28px rgba(0,0,0,.4); background: radial-gradient(120% 120% at 0% 0%, rgba(59,130,246,.12), transparent 40%), rgba(10,12,16,.6); }
        .icf-tile:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.35); }
        /* Tailwind-like buttons for intentions */
        .tw-btn { display: inline-flex; align-items: center; justify-content: center; gap: .6rem; padding: .75rem .9rem; border-radius: .75rem; border: 1px solid rgba(59,130,246,.22); background: rgba(10,12,16,.55); color: var(--text-primary); cursor: pointer; transition: transform .14s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease; user-select: none; }
        .tw-btn:hover { transform: translateY(-1px); border-color: rgba(59,130,246,.45); background: rgba(9,12,20,.6); }
        .tw-btn[aria-pressed="true"] { border-color: rgba(59,130,246,.7); box-shadow: 0 0 0 2px rgba(59,130,246,.2), 0 10px 24px rgba(0,0,0,.35); background: linear-gradient(180deg, rgba(9,12,20,.75), rgba(9,12,20,.55)); }
        .tw-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .9rem; margin-top: .75rem; }
        @media (max-width: 640px){ .tw-grid { grid-template-columns: 1fr; } }
        .icon-badge { display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:8px; background: radial-gradient(circle at 30% 20%, rgba(59,130,246,.45), rgba(59,130,246,.15)); outline: 1px solid rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(0,0,0,.3), 0 2px 8px rgba(59,130,246,.25); font-size: 13px; }
        .tw-btn span.label { line-height: 1.3; }
        .other-wrap { display:none; margin:0; height:0; margin-top: 20px; margin-bottom: 4px;}
        .other-wrap.active { display:block; animation: icfFadeUp .25s ease both; }
        .other-input { width:100%; padding:.8rem 1rem; background: rgba(0,0,0,.25); border: 1px solid rgba(59,130,246,.22); border-radius:.6rem; color: var(--text-primary); }
        .other-input:focus { outline:none; border-color: var(--purple-500); box-shadow: 0 0 0 2px rgba(59,130,246,.25); }
        .icf-check { display: flex; align-items: center; gap: .8rem; padding: .85rem 1rem; border: 1px solid rgba(59,130,246,.22); border-radius: .7rem; background: rgba(7,7,7,.42); transition: transform .14s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease; cursor: pointer; min-height: 60px; }
        .icf-check:has(input:checked) { border-color: rgba(59,130,246,.65); box-shadow: 0 0 0 2px rgba(59,130,246,.18), 0 10px 24px rgba(0,0,0,.35); background: linear-gradient(180deg, rgba(9,12,20,.75), rgba(9,12,20,.55)); }
        .icf-check:hover { border-color: rgba(59,130,246,.45); background: rgba(9,12,20,.6); transform: translateY(-1px); }
        .icf-check input { margin-top: .2rem; }
        /* Custom checkbox styling for clarity and alignment */
        .icf-check input[type="checkbox"] {
          appearance: none;
          -webkit-appearance: none;
          width: 14px; height: 14px; border-radius: 4px;
          border: 1.5px solid rgba(59,130,246,.6);
          background: rgba(0,0,0,.25); position: relative; flex: 0 0 14px;
        }
        .icf-check input[type="checkbox"]:hover { border-color: var(--purple-500); }
        .icf-check input[type="checkbox"]:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.25); }
        .icf-check input[type="checkbox"]:checked {
          border-color: var(--purple-500);
          background: linear-gradient(135deg, var(--purple-600), var(--accent-600));
        }
        .icf-check input[type="checkbox"]:checked::after {
          content: '';
          position: absolute; left: 3.5px; top: 0.5px; width: 5px; height: 8px;
          border: 2px solid white; border-top: none; border-left: none;
          transform: rotate(45deg);
        }
        .icf-check:hover { border-color: rgba(59,130,246,.45); background: rgba(0,0,0,.28); }
        .icf-check:focus-within { box-shadow: 0 0 0 3px rgba(59,130,246,.25); }
        .icf-text { display: flex; flex-direction: column; align-items: flex-start; color: var(--text-primary); line-height: 1.45; text-align: left; white-space: normal; word-break: normal; width: 100%; }
        .consent-row { display: flex !important; align-items: flex-start !important; gap: .75rem; padding: 1rem; border: 1px solid rgba(59,130,246,.22); border-radius: .75rem; background: rgba(7,7,7,.3); }
        .consent-row input[type="checkbox"] { margin-top: .2rem; }
        .consent-row .icf-text { margin: 0; line-height: 1.4; }
        .consent-submit { width: 100%; max-width: 320px; margin: 1rem auto 0; padding: .85rem 1.5rem; font-size: .95rem; }
        
        /* Thank you screen styling */
        .thanks-content { text-align: center; }
        .thanks-icon { font-size: 3rem; margin-bottom: 1rem; }
        .thanks-content h2 { font-size: 1.75rem; margin-bottom: 1rem; color: var(--text-primary); }
        .thanks-message { font-size: 1.1rem; line-height: 1.5; margin-bottom: 1.5rem; color: var(--text-secondary); }
        .thanks-details { text-align: left; margin: 1.5rem 0; padding: 1rem; background: rgba(7,7,7,.3); border-radius: .75rem; border: 1px solid rgba(59,130,246,.15); }
        .thanks-details p { margin-bottom: .75rem; color: var(--text-primary); }
        .thanks-details ul { margin: 0; padding-left: 1.25rem; }
        .thanks-details li { margin-bottom: .5rem; color: var(--text-secondary); line-height: 1.4; }
        
        /* Validation styling */
        .validation-error { 
          color: #f87171; 
          font-size: 0.875rem; 
          margin-top: 0.5rem; 
          text-align: center; 
          animation: fadeIn 0.3s ease; 
        }
        
        /* Invalid field highlighting */
        .icf-input-error {
          border-color: #f87171 !important;
          box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.25) !important;
        }
        
        /* Conditional field transitions */
        .conditional-step {
          transition: opacity 0.3s ease, max-height 0.3s ease;
          overflow: hidden;
        }
        
        .conditional-step.hidden {
          opacity: 0;
          max-height: 0;
          pointer-events: none;
        }
        
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-4px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .icf-text strong { display: block; font-weight: 640; letter-spacing: .1px; margin-bottom: .1rem; font-size: 1rem; }
        .icf-text small { display: block; color: var(--text-secondary); font-size: .9rem; max-width: 60ch; }
        .icf-option { display: contents; }
        .icf-progress { height: 10px; width: 100%; border-radius: 999px; background: rgba(255,255,255,.06); overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,.4); }
        .icf-progress > .bar { height: 100%; width: 0%; background: linear-gradient(135deg, var(--purple-600), var(--accent-600)); transition: width .25s ease; box-shadow: 0 1px 8px rgba(59,130,246,.45); }
        .icf-label { display: flex; justify-content: space-between; font-size: .75rem; color: var(--text-secondary); margin-bottom: .35rem; }
        textarea { width: 100%; padding: 1rem; background: rgba(0,0,0,.2); border: 1px solid rgba(59,130,246,.18); border-radius: .6rem; color: var(--text-primary); min-height: 140px; }
        textarea:focus { outline: none; border-color: var(--purple-500); box-shadow: 0 0 0 2px rgba(59,130,246,.25); }
        input[type="text"], input[type="email"] { width: 100%; padding: 1rem; background: rgba(0,0,0,.2); border: 1px solid rgba(59,130,246,.18); border-radius: .6rem; color: var(--text-primary); }
        input[type="text"]:focus, input[type="email"]:focus { outline: none; border-color: var(--purple-500); box-shadow: 0 0 0 2px rgba(59,130,246,.25); }
        label.block span.block { font-size: .9rem; letter-spacing: .2px; }
        h2.center { letter-spacing: .2px; }
        .button, button { box-shadow: 0 10px 24px rgba(59,130,246,.22); }
        .button:hover, button:hover { transform: translateY(-2px); box-shadow: 0 16px 30px rgba(59,130,246,.28); }
        .icf-step.active { animation: icfFadeUp .35s ease both; }
        @keyframes icfFadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 640px) { .icf-name-grid { grid-template-columns: 1fr !important; } }
        .center { text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <!--<div class="hero">
            <h1>Join the Inner Circle</h1>
            <p class="subtitle">Early supporters shaping waQup‚Äôs journey. Flow through a few quick steps.</p>
        </div>  -->
        <div class="cta-section" id="icf">
            <div class="icf-top">
              <div class="icf-label">
                  <span id="icf-step-text">Step 1 of 11</span>
                  <span id="icf-percent">9%</span>
              </div>
              <div class="icf-progress"><div class="bar" id="icf-bar" style="width: 9%"></div></div>
            </div>

            <div class="icf-viewport" id="icf-viewport">
                <!-- 0. Intentions -->
                <section class="icf-step active" data-step="0">
                    <div class="icf-card">
                        <h2 class="center" style="margin-bottom: .25rem;">How are you most drawn to use waQup?</h2>
                        <p class="center" style="color: var(--text-secondary); margin-bottom:.75rem;">You can choose more than one. This helps us build the right experience for you.</p>
                        <div class="tw-grid" id="icf-intentions">
                            <button type="button" class="tw-btn" aria-pressed="false" aria-label="For my own inner work and healing" data-value="user"><span class="icon-badge">üåø</span><span class="label">For my own inner work and healing</span></button>
                            <button type="button" class="tw-btn" aria-pressed="false" aria-label="To guide others using my voice or presence" data-value="facilitator"><span class="icon-badge">üé§</span><span class="label">To guide others using my voice or presence</span></button>
                            <button type="button" class="tw-btn" aria-pressed="false" aria-label="To share this in a space I hold" data-value="venue"><span class="icon-badge">üè†</span><span class="label">To share this in a space I hold</span></button>
                            <button type="button" class="tw-btn" aria-pressed="false" aria-label="Other intention" data-value="other"><span class="icon-badge">‚ûï</span><span class="label">Other</span></button>
                        </div>
                        <div class="other-wrap" id="icf-other-wrap">
                            <input type="text" id="icf-other-input" class="other-input" placeholder="Tell us more...">
                        </div>
                    </div>
                </section>

                <!-- 1. Name (First + Last) -->
                <section class="icf-step" data-step="1">
                    <div class="icf-card">
                        <div class="icf-grid icf-name-grid" style="grid-template-columns: 1fr 1fr; gap: .75rem;">
                            <label class="block">
                                <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">First name</span>
                                <input type="text" id="icf-first-name" name="firstName" placeholder="Jane">
                            </label>
                            <label class="block">
                                <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">Last name</span>
                                <input type="text" id="icf-last-name" name="lastName" placeholder="Doe">
                            </label>
                        </div>
                    </div>
                </section>

                <!-- 2. Email -->
                <section class="icf-step" data-step="2">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">Your email</span>
                            <input type="email" id="icf-email" name="email" placeholder="you@example.com">
                        </label>
                    </div>
                </section>

                <!-- 3. Calling -->
                <section class="icf-step" data-step="3">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">What‚Äôs calling you right now?</span>
                            <textarea id="icf-calling" name="calling" placeholder="Share anything that feels alive for you"></textarea>
                        </label>
                    </div>
                </section>

                <!-- 4. Hard to shift -->
                <section class="icf-step" data-step="4">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">What feels hard to shift or sustain?</span>
                            <textarea id="icf-hard" name="challenges" placeholder="Patterns, habits, or challenges you notice"></textarea>
                        </label>
                    </div>
                </section>

                <!-- 5. Support look like -->
                <section class="icf-step" data-step="5">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">What would support look like?</span>
                            <textarea id="icf-support" name="support" placeholder="What would help you most right now?"></textarea>
                        </label>
                    </div>
                </section>

                <!-- 6. Resonance -->
                <section class="icf-step" data-step="6">
                    <div class="icf-card">
                        <h2 class="center" style="margin-bottom:.75rem;">What resonates?</h2>
                        <div class="icf-grid">
                            <label class="icf-check" tabindex="0" role="checkbox" aria-checked="false">
                                <input class="icf-option" type="checkbox" name="resonance" value="affirmations">
                                <span class="icf-text"><strong>Affirmations</strong><small>Short, positive statements to rewire beliefs and focus attention.</small></span>
                            </label>
                            <label class="icf-check" tabindex="0" role="checkbox" aria-checked="false">
                                <input class="icf-option" type="checkbox" name="resonance" value="mantras">
                                <span class="icf-text"><strong>Mantras</strong><small>Rhythmic phrases or sounds repeated to steady the mind.</small></span>
                            </label>
                            <label class="icf-check" tabindex="0" role="checkbox" aria-checked="false">
                                <input class="icf-option" type="checkbox" name="resonance" value="rituals">
                                <span class="icf-text"><strong>Rituals</strong><small>Simple, repeatable actions that anchor desired states in daily life.</small></span>
                            </label>

                        </div>
                    </div>
                </section>

                <!-- 7. Facilitator optional -->
                <section class="icf-step" data-step="7">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">If you facilitate, anything you‚Äôd like to share? (optional)</span>
                            <textarea id="icf-facilitator" name="facilitator" placeholder="Modalities, interests, offerings"></textarea>
                        </label>
                    </div>
                </section>

                <!-- 8. Venue optional -->
                <section class="icf-step conditional-step hidden" data-step="8">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">If you have a venue, tell us more (optional)</span>
                            <textarea id="icf-venue" name="venue" placeholder="Location, capacity, intentions"></textarea>
                        </label>
                    </div>
                </section>

                <!-- 9. Anything else -->
                <section class="icf-step conditional-step hidden" data-step="9">
                    <div class="icf-card">
                        <label class="block">
                            <span class="block" style="color: var(--text-secondary); margin-bottom:.5rem;">Anything else? (optional)</span>
                            <textarea id="icf-anything" name="anythingElse" placeholder="Share anything you‚Äôd like us to know"></textarea>
                        </label>
                    </div>
                </section>

                <!-- 10. Final consent + CTA -->
                <section class="icf-step" data-step="10">
                    <div class="icf-card">
                        <label class="icf-check consent-row" tabindex="0" role="checkbox" aria-checked="false">
                            <input class="icf-option" type="checkbox" id="icf-consent">
                            <span class="icf-text">  I understand this form connects me to the waQup Inner Circle. I‚Äôm open to receiving updates and invitations aligned with this journey.
                            </span>
                        </label>
                        <button id="icf-submit" class="consent-submit">Join the Circle</button>
                    </div>
                </section>
            </div>

            <div class="icf-controls">
                <button class="ghost" id="icf-back" disabled>Back</button>
                <button id="icf-next">Next</button>
            </div>
        </div>

        <div class="cta-section center" id="icf-thanks" style="display:none;">
            <h2 style="font-size:1.75rem; margin-bottom:.5rem;">Thank you</h2>
            <p class="subtitle" style="margin:0 auto;">We‚Äôve received your interest for the Inner Circle. We‚Äôll be in touch.</p>
            <p style="margin-top:1rem;"><a href="https://waqup.space" class="button">Back to Home</a></p>
        </div>
    </div>

    <script>
      (function(){
        const viewport = document.getElementById('icf-viewport');
        const steps = Array.from(viewport.querySelectorAll('.icf-step'));
        const back = document.getElementById('icf-back');
        const next = document.getElementById('icf-next');
        const submit = document.getElementById('icf-submit');
        const bar = document.getElementById('icf-bar');
        const stepText = document.getElementById('icf-step-text');
        const percent = document.getElementById('icf-percent');
        const thanks = document.getElementById('icf-thanks');
        const formCard = document.getElementById('icf');

        let index = 0;

        // Form state management with localStorage backup
        const STORAGE_KEY = 'icf_form_data';
        const formState = {
          intentions: [],
          firstName: '',
          lastName: '',
          email: '',
          calling: '',
          challenges: '',
          support: '',
          resonance: [],
          facilitator: '',
          venue: '',
          anythingElse: '',
          consent: false,
          otherText: ''
        };

        // Load saved form data
        function loadFormData() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              Object.assign(formState, parsed);
              
              // Restore form values
              restoreFormValues();
              
              // Restore step if available
              const savedStep = localStorage.getItem('icf_current_step');
              if (savedStep) {
                index = parseInt(savedStep);
                updateUI();
              }
            }
          } catch (error) {
            console.warn('Failed to load form data:', error);
          }
        }

        // Save form data
        function saveFormData() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
            localStorage.setItem('icf_current_step', index.toString());
          } catch (error) {
            console.warn('Failed to save form data:', error);
          }
        }

        // Restore form values from state
        function restoreFormValues() {
          // Restore intentions
          if (formState.intentions.length > 0) {
            formState.intentions.forEach(val => {
              const btn = document.querySelector(`[data-value="${val}"]`);
              if (btn) {
                btn.setAttribute('aria-pressed', 'true');
                if (val === 'other') {
                  const otherWrap = document.getElementById('icf-other-wrap');
                  const otherInput = document.getElementById('icf-other-input');
                  if (otherWrap && otherInput) {
                    otherWrap.classList.add('active');
                    otherWrap.style.height = 'auto';
                    otherInput.value = formState.otherText || '';
                  }
                }
              }
            });
          }

          // Restore other form fields
          const fields = ['firstName', 'lastName', 'email', 'calling', 'challenges', 'support', 'facilitator', 'venue', 'anythingElse'];
          fields.forEach(field => {
            const input = document.querySelector(`[name="${field}"]`);
            if (input && formState[field]) {
              input.value = formState[field];
            }
          });

          // Restore resonance checkboxes
          if (formState.resonance.length > 0) {
            formState.resonance.forEach(val => {
              const checkbox = document.querySelector(`input[value="${val}"]`);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }

          // Restore consent
          if (formState.consent) {
            const consentCheckbox = document.getElementById('icf-consent');
            if (consentCheckbox) {
              consentCheckbox.checked = true;
            }
          }
        }

        // Validation functions for each step
        function validateStep(stepIndex) {
          switch(stepIndex) {
            case 0: // Intentions
              return formState.intentions.length > 0;
            
            case 1: // First Name and Last Name
              return formState.firstName.trim().length > 0 && formState.lastName.trim().length > 0;
            
            case 2: // Email
              const email = formState.email.trim();
              return email.length > 0 && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            
            case 3: // What's calling you
              return formState.calling.trim().length > 0;
            
            case 4: // What feels hard
              return formState.challenges.trim().length > 0;
            
            case 5: // What would support look like
              return formState.support.trim().length > 0;
            
            case 6: // Resonance
              return formState.resonance.length > 0;
            
            case 7: // Facilitator (conditional)
              if (formState.intentions.includes('facilitator')) {
                return formState.facilitator.trim().length > 0;
              }
              return true;
            
            case 8: // Venue (conditional)
              if (formState.intentions.includes('venue')) {
                return formState.venue.trim().length > 0;
              }
              return true;
            
            case 9: // Anything else (conditional)
              return true; // Optional field
            
            case 10: // Consent
              return formState.consent;
            
            default:
              return true;
          }
        }

        // Show validation errors for current step
        function showStepValidation() {
          const currentStep = steps[index];
          const errorElements = currentStep.querySelectorAll('.validation-error');
          errorElements.forEach(el => el.remove());

          // Remove error styling from all fields in current step
          currentStep.querySelectorAll('.icf-input-error').forEach(el => {
            el.classList.remove('icf-input-error');
          });

          let isValid = true;
          let errorMessage = '';

          switch(index) {
            case 0: // Intentions
              if (formState.intentions.length === 0) {
                errorMessage = 'Please select at least one intention to continue.';
                isValid = false;
              }
              break;
            
            case 1: // First Name and Last Name
              if (formState.firstName.trim().length === 0) {
                errorMessage = 'First name is required.';
                isValid = false;
                const input = currentStep.querySelector('input[name="firstName"]');
                if (input) input.classList.add('icf-input-error');
              }
              if (formState.lastName.trim().length === 0) {
                if (errorMessage) {
                  errorMessage += ' Last name is also required.';
                } else {
                  errorMessage = 'Last name is required.';
                }
                isValid = false;
                const input = currentStep.querySelector('input[name="lastName"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 2: // Email
              if (formState.email.trim().length === 0) {
                errorMessage = 'Email is required.';
                isValid = false;
                const input = currentStep.querySelector('input[name="email"]');
                if (input) input.classList.add('icf-input-error');
              } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formState.email.trim())) {
                errorMessage = 'Please enter a valid email address.';
                isValid = false;
                const input = currentStep.querySelector('input[name="email"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 3: // What's calling you
              if (formState.calling.trim().length === 0) {
                errorMessage = 'This field is required to understand your journey.';
                isValid = false;
                const input = currentStep.querySelector('textarea[name="calling"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 4: // What feels hard
              if (formState.challenges.trim().length === 0) {
                errorMessage = 'This field is required to understand your challenges.';
                isValid = false;
                const input = currentStep.querySelector('textarea[name="challenges"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 5: // What would support look like
              if (formState.support.trim().length === 0) {
                errorMessage = 'This field is required to understand your support needs.';
                isValid = false;
                const input = currentStep.querySelector('textarea[name="support"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 6: // Resonance
              if (formState.resonance.length === 0) {
                errorMessage = 'Please select at least one resonance type.';
                isValid = false;
                const checkboxes = currentStep.querySelectorAll('input[name="resonance"]');
                checkboxes.forEach(cb => cb.classList.add('icf-input-error'));
              }
              break;
            
            case 7: // Facilitator (conditional)
              if (formState.intentions.includes('facilitator') && formState.facilitator.trim().length === 0) {
                errorMessage = 'This field is required for facilitators.';
                isValid = false;
                const input = currentStep.querySelector('textarea[name="facilitator"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 8: // Venue (conditional)
              if (formState.intentions.includes('venue') && formState.venue.trim().length === 0) {
                errorMessage = 'This field is required for venue holders.';
                isValid = false;
                const input = currentStep.querySelector('textarea[name="venue"]');
                if (input) input.classList.add('icf-input-error');
              }
              break;
            
            case 9: // Anything else (conditional)
              return true; // Optional field
            
            case 10: // Consent
              if (!formState.consent) {
                errorMessage = 'You must consent to continue.';
                isValid = false;
                const checkbox = currentStep.querySelector('#icf-consent');
                if (checkbox) checkbox.classList.add('icf-input-error');
              }
              break;
          }

          if (!isValid && errorMessage) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.textContent = errorMessage;
            
            const stepContent = currentStep.querySelector('.icf-card');
            stepContent.appendChild(errorDiv);
          }

          return isValid;
        }

        // Handle conditional field visibility
        function updateConditionalFields() {
          const facilitatorStep = steps[7]; // Step 8
          const venueStep = steps[8]; // Step 9
          
          if (formState.intentions.includes('facilitator')) {
            facilitatorStep.classList.remove('hidden');
          } else {
            facilitatorStep.classList.add('hidden');
            formState.facilitator = '';
          }
          
          if (formState.intentions.includes('venue')) {
            venueStep.classList.remove('hidden');
          } else {
            venueStep.classList.add('hidden');
            formState.venue = '';
          }
        }

        const intentions = document.getElementById('icf-intentions');
        const otherWrap = document.getElementById('icf-other-wrap');
        const otherInput = document.getElementById('icf-other-input');
        if (intentions) {
          intentions.querySelectorAll('.tw-btn').forEach((btn)=>{
            btn.addEventListener('click', function(){
              const val = btn.getAttribute('data-value');
              const idx = formState.intentions.indexOf(val);
              if (idx === -1) { formState.intentions.push(val); btn.setAttribute('aria-pressed','true'); }
              else { formState.intentions.splice(idx,1); btn.setAttribute('aria-pressed','false'); }

              if (val === 'other') {
                const isOn = btn.getAttribute('aria-pressed') === 'true';
                if (isOn) {
                  otherWrap.classList.add('active');
                  requestAnimationFrame(()=>{ otherWrap.style.height = otherInput.scrollHeight + 'px'; otherInput.focus(); });
                } else {
                  otherWrap.style.height = '0px';
                  setTimeout(()=>{ otherWrap.classList.remove('active'); otherInput.value = ''; }, 200);
                }
              }
              
              updateConditionalFields();
              saveFormData();
            });
            btn.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); } });
          });
        }

        // Collect all form data
        function collectFormData() {
          // Collect intentions
          formState.intentions = [];
          document.querySelectorAll('.tw-btn[aria-pressed="true"]').forEach(btn => {
            const val = btn.getAttribute('data-value');
            formState.intentions.push(val);
            if (val === 'other') {
              const otherInput = document.getElementById('icf-other-input');
              if (otherInput) {
                formState.otherText = otherInput.value;
              }
            }
          });

          // Collect other form fields
          const fields = ['firstName', 'lastName', 'email', 'calling', 'challenges', 'support', 'facilitator', 'venue', 'anythingElse'];
          fields.forEach(field => {
            const input = document.querySelector(`[name="${field}"]`);
            if (input) {
              formState[field] = input.value.trim();
            }
          });

          // Collect resonance
          formState.resonance = [];
          document.querySelectorAll('input[name="resonance"]:checked').forEach(checkbox => {
            formState.resonance.push(checkbox.value);
          });

          // Collect consent
          const consentCheckbox = document.getElementById('icf-consent');
          formState.consent = consentCheckbox ? consentCheckbox.checked : false;

          return formState;
        }

        // Submit form data to Google Form
        async function submitForm() {
          const formData = collectFormData();
          
          // Show loading state
          submit.disabled = true;
          submit.textContent = 'Submitting...';
          
          try {
            // Construct Google Form URL with form data
            const baseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSetQWPLa5OMkh7t7zjlimOrVDQiH2ztEGf85kgrG4zC0meLAQ/formResponse';
            
            // Create form data for Google Form
            const googleFormData = new FormData();
            
            // Intentions (multiple entries for same field ID)
            const intentionLabels = {
              'user': 'For my own inner work and healing',
              'facilitator': 'To guide others using my voice or presence',
              'venue': 'To share this in a space I hold',
              'other': formData.otherText || 'Other'
            };
            
            formData.intentions.forEach(intention => {
              const label = intentionLabels[intention];
              if (label) {
                googleFormData.append('entry.1041452331', label);
              }
            });
            
            // Name (combine first and last name)
            const fullName = `${formData.firstName} ${formData.lastName}`.trim();
            googleFormData.append('entry.1903849690', fullName);
            
            // Email
            googleFormData.append('entry.983067988', formData.email);
            
            // What's calling you
            googleFormData.append('entry.1149286496', formData.calling);
            
            // What feels hard to shift
            googleFormData.append('entry.1544444455', formData.challenges);
            
            // What would support look like
            googleFormData.append('entry.1851558045', formData.support);
            
            // Resonance (multiple entries for same field ID)
            const resonanceLabels = {
              'affirmations': 'Affirmations',
              'mantras': 'Mantras',
              'rituals': 'Rituals'
            };
            
            formData.resonance.forEach(resonance => {
              const label = resonanceLabels[resonance];
              if (label) {
                googleFormData.append('entry.1213801279', label);
              }
            });
            
            // Facilitator (only if selected)
            if (formData.intentions.includes('facilitator') && formData.facilitator) {
              googleFormData.append('entry.48136303', formData.facilitator);
            }
            
            // Venue (only if selected)
            if (formData.intentions.includes('venue') && formData.venue) {
              googleFormData.append('entry.1345763933', formData.venue);
            }
            
            // Anything else (optional)
            if (formData.anythingElse) {
              googleFormData.append('entry.413368915', formData.anythingElse);
            }
            
            // Submit to Google Form using fetch with POST
            const response = await fetch(baseUrl, {
              method: 'POST',
              body: googleFormData,
              mode: 'no-cors' // Required for Google Forms
            });
            
            // Google Forms always returns 200 even on success, so we assume success
            // Clear localStorage and show thanks
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem('icf_current_step');
            
            formCard.style.display = 'none';
            thanks.style.display = 'block';
            
          } catch (error) {
            console.error('Submission failed:', error);
            
            // Fallback: show thanks anyway (offline mode)
            submit.textContent = 'Offline Mode - Thank You!';
            setTimeout(() => {
              localStorage.removeItem(STORAGE_KEY);
              localStorage.removeItem('icf_current_step');
              
              formCard.style.display = 'none';
              thanks.style.display = 'block';
            }, 1000);
          }
        }

        // Auto-save form inputs
        function setupAutoSave() {
          const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
          inputs.forEach(input => {
            input.addEventListener('input', () => {
              // Remove error styling when user starts typing
              input.classList.remove('icf-input-error');
              saveFormData();
            });
          });

          const checkboxes = document.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
              // Remove error styling when user makes selection
              checkbox.classList.remove('icf-input-error');
              saveFormData();
            });
          });
        }

        function updateUI(){
          steps.forEach((el,i)=>{
            el.classList.toggle('active', i===index);
          });
          back.disabled = index===0;
          next.disabled = index>=steps.length-1;
          const pct = Math.round(((index+1)/steps.length)*100);
          bar.style.width = pct+'%';
          stepText.textContent = 'Step '+(index+1)+' of '+steps.length;
          percent.textContent = pct+'%';
          
          saveFormData();
        }

        function go(delta){
          if (delta > 0) { // Moving forward - validate current step
            if (!validateStep(index)) {
              showStepValidation();
              return;
            }
          }
          
          const nextIndex = Math.max(0, Math.min(steps.length-1, index+delta));
          if(nextIndex!==index){ 
            index = nextIndex; 
            updateUI(); 
          }
        }

        back.addEventListener('click', ()=> go(-1));
        next.addEventListener('click', ()=> go(1));

        if(submit){
          submit.addEventListener('click', function(){
            const consent = document.getElementById('icf-consent');
            if(consent && consent.checked){
              submitForm();
            } else {
              showStepValidation();
            }
          });
        }

        // Initialize
        loadFormData();
        setupAutoSave();
        updateConditionalFields();
        updateUI();
      })();
    </script>
</body>
</html>